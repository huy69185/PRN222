@model List<ClassroomBooking.Service.Dtos.BookingDto>
@{
    ViewData["Title"] = "My Bookings";
}

<h2 class="mb-4">My Bookings</h2>

@if (TempData["Error"] != null)
{
    <div style="color: red; margin-bottom: 1rem;">@TempData["Error"]</div>
}

<div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
    <form method="get" style="display: flex; gap: 0.5rem;">
        <input type="text" name="searchRoom" value="@ViewBag.SearchRoom" placeholder="Search by room..." style="padding: 0.5rem;" />
        <input type="text" name="searchPurpose" value="@ViewBag.SearchPurpose" placeholder="Search by purpose..." style="padding: 0.5rem;" />
        <select name="statusFilter" style="padding: 0.4rem;">
            <option value="">All Status</option>
            <option value="Approved" @(ViewBag.StatusFilter == "Approved" ? "selected" : "")>Approved</option>
            <option value="Denied" @(ViewBag.StatusFilter == "Denied" ? "selected" : "")>Denied</option>
            <option value="Pending" @(ViewBag.StatusFilter == "Pending" ? "selected" : "")>Pending</option>
            <option value="Cancelled" @(ViewBag.StatusFilter == "Cancelled" ? "selected" : "")>Cancelled</option>
        </select>
        <button type="submit" style="padding: 0.5rem;">Search</button>
    </form>

    <a href="http://localhost:5000/Bookings/Create" style="background-color: #2f74c0; color: #fff; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px;">
        Create Booking
    </a>
</div>

<table style="width:100%; border-collapse: collapse; border: 1px solid #ccc;">
    <thead style="background-color: #2f74c0; color: #fff;">
        <tr>
            <th style="padding: 8px; border:1px solid #ccc;">ID</th>
            <th style="padding: 8px; border:1px solid #ccc;">Room</th>
            <th style="padding: 8px; border:1px solid #ccc;">Start Time</th>
            <th style="padding: 8px; border:1px solid #ccc;">End Time</th>
            <th style="padding: 8px; border:1px solid #ccc;">Purpose</th>
            <th style="padding: 8px; border:1px solid #ccc;">Status</th>
            <th style="padding: 8px; border:1px solid #ccc;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model == null || Model.Count == 0)
        {
            <tr>
                <td colspan="7" style="padding: 8px; text-align: center;">No bookings found.</td>
            </tr>
        }
        else
        {
            foreach (var b in Model)
            {
                <tr>
                    <td style="padding: 8px; border:1px solid #ccc;">@b.BookingId</td>
                    <td style="padding: 8px; border:1px solid #ccc;">@(b.RoomSlots.FirstOrDefault()?.Room?.RoomName ?? "-")</td>
                    <td style="padding: 8px; border:1px solid #ccc;">@b.StartTime.ToString("dd/MM/yyyy HH:mm")</td>
                    <td style="padding: 8px; border:1px solid #ccc;">@b.EndTime.ToString("dd/MM/yyyy HH:mm")</td>
                    <td style="padding: 8px; border:1px solid #ccc;">@b.Purpose</td>
                    <td style="padding: 8px; border:1px solid #ccc;">@b.BookingStatus</td>
                    <td style="padding: 8px; border:1px solid #ccc;">
                        @if (b.BookingStatus == "Pending" || b.BookingStatus == "Approved")
                        {
                            <form action="/Bookings/Cancel" method="post" style="display:inline;">
                                <input type="hidden" name="id" value="@b.BookingId" />
                                <button type="submit" style="background-color:#c02f2f; color:#fff; border:none; padding: 0.3rem 0.7rem; border-radius:4px;"
                                        onclick="return confirm('Are you sure you want to cancel this booking?');">
                                    Cancel
                                </button>
                            </form>
                        }
                        else
                        {
                            <span style="color:#999;">N/A</span>
                        }
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/bookingHub")
            .build();

        connection.on("ReceiveBookingNotification", (message) => {
            alert(message);
        });

        connection.start();
    </script>
}